<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>src/hiraya-game/level-turnbased.js - hiraya</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.7.0/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="stylesheet" href="../assets/vendor/bootstrap/css/bootstrap.css">
    <link rel="stylesheet" href="../assets/vendor/bootstrap/css/bootstrap-responsive.css">
    <link rel="stylesheet" href="../assets/css/custom.css">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
</head>
<body class="yui3-skin-sam">
<div class="navbar navbar-fixed-top">
    <div class="navbar-inner">
        <h1 class="brand" style="padding: 10px 16px 10px; height: 20px; line-height: 20px; margin-left: 0;">
        hiraya
        </h1>
	<div class="nav">
            <li class="divider-vertical"></li>
            <li>
                <p class="navbar-text">
                    API Docs for Version: <b>0.0.1</b>
                </p>
            </li>
        </div>
        <form class="navbar-form pull-right" style="line-height: 40px; height: 40px;">
            <input style="margin-top: 0;" type="text" class="search-query" placeholder="Search for classes/modules..." data-obj='["classes/Hiraya.Canvas", "classes/Hiraya.Class", "classes/Hiraya.Collection", "classes/Hiraya.Emitter", "classes/Hiraya.Entity", "classes/Hiraya.Game", "classes/Hiraya.GetterSetter", "classes/Hiraya.Level", "classes/Hiraya.LevelTurnBased", "classes/Hiraya.Sprite", "classes/Hiraya.Stat", "classes/Hiraya.Stats", "classes/Hiraya.Tile", "classes/Hiraya.Tiles", "modules/hiraya", "modules/hiraya-core", "modules/hiraya-game", "modules/hiraya-view"]'>
        </form>
    </div>
</div>
<div class="container">
    <div class="row">
        <div class="span3">
	    <div>
    <h3>APIs</h3>
    <div id="sidebar">
        <ul id="main-nav" class="nav nav-tabs" style="margin-bottom:0;">
            <li class="active"><a href="#classes" data-toggle="tab">Classes</a></li>
            <li><a href="#modules" data-toggle="tab">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" placeholder="Type to filter APIs">
        </div>

        <div class="tab-content" style="border: 1px solid #DDD; border-top:0;">
            <div class="tab-pane active" id="classes">
                <ul id="api-classes" class="nav nav-list">
                    
                        <li><a href="../classes/Hiraya.Canvas.html">Hiraya.Canvas</a></li>
                    
                        <li><a href="../classes/Hiraya.Class.html">Hiraya.Class</a></li>
                    
                        <li><a href="../classes/Hiraya.Collection.html">Hiraya.Collection</a></li>
                    
                        <li><a href="../classes/Hiraya.Emitter.html">Hiraya.Emitter</a></li>
                    
                        <li><a href="../classes/Hiraya.Entity.html">Hiraya.Entity</a></li>
                    
                        <li><a href="../classes/Hiraya.Game.html">Hiraya.Game</a></li>
                    
                        <li><a href="../classes/Hiraya.GetterSetter.html">Hiraya.GetterSetter</a></li>
                    
                        <li><a href="../classes/Hiraya.Level.html">Hiraya.Level</a></li>
                    
                        <li><a href="../classes/Hiraya.LevelTurnBased.html">Hiraya.LevelTurnBased</a></li>
                    
                        <li><a href="../classes/Hiraya.Sprite.html">Hiraya.Sprite</a></li>
                    
                        <li><a href="../classes/Hiraya.Stat.html">Hiraya.Stat</a></li>
                    
                        <li><a href="../classes/Hiraya.Stats.html">Hiraya.Stats</a></li>
                    
                        <li><a href="../classes/Hiraya.Tile.html">Hiraya.Tile</a></li>
                    
                        <li><a href="../classes/Hiraya.Tiles.html">Hiraya.Tiles</a></li>
                    
                </ul>
            </div>

            <div class="tab-pane" id="modules">
                <ul id="api-modules" class="nav nav-list">
                    
                        <li><a href="../modules/hiraya.html">hiraya</a></li>
                    
                        <li><a href="../modules/hiraya-core.html">hiraya-core</a></li>
                    
                        <li><a href="../modules/hiraya-game.html">hiraya-game</a></li>
                    
                        <li><a href="../modules/hiraya-view.html">hiraya-view</a></li>
                    
                </ul>
            </div>
        </div>
    </div>
</div>

        </div>
        <div class="span9">
                <form id="options-form" class="form-inline pull-right">
        Show:
        <label for="api-show-inherited" class="checkbox">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected" class="checkbox">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private" class="checkbox">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated" class="checkbox">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </form>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <div class="page-header">
    <h1>src/hiraya-game/level-turnbased.js <small>File</small></h1>
</div>

<div class="file">
    <pre class="prettyprint linenums">
/**
 * @module hiraya
 * @submodule hiraya-game
 */


var Level = require(&#x27;./level&#x27;);
var EntityTurnBased = require(&#x27;./entity-turnbased&#x27;);

/**
 * &#x60;Hiraya.LevelTurnBased&#x60; manages entities and game logic for turn-based games.
 *
 * ### Events
 *
 * - &#x60;getTurnTimedOut&#x60;
 * - &#x60;gotTurn&#x60;
 * - &#x60;hasNoWinnerYet&#x60;
 * - &#x60;hasWinner&#x60;
 *
 * @class LevelTurnBased
 * @extends Hiraya.Level
 * @namespace Hiraya
 */
var LevelTurnBased = Level.extend({
  Entity: EntityTurnBased,

  /**
   * Determines how fast the tick for the turn calculation will be.
   *
   * @property tickSpeed
   * @type {Number}
   * @default 1
   */
  tickSpeed: 1,

  /**
   * Determines the number of tries the &#x60;.getTurn()&#x60; function can do before
   * giving up.
   *
   * @property _maxGetTurnAttempts
   * @type {Number}
   * @private
   * @default 25
   */
  _maxGetTurnAttempts: 25,

  /**
   * Finds the next entity to take its turn.
   *
   * @method getTurn
   */
  getTurn: function() {
    var entity, _this = this;
    var tries = 0;
    var maxTries = this._maxGetTurnAttempts;
    var tick = function() {
      entity = _this._getEntityTurn();
      tries++;
      if (!entity) {
        if (tries &lt; maxTries) {
          setTimeout(tick, _this.tickSpeed);
        } else {
          _this.getTurnTimedOut();
        }
      } else {
        entity.stats.turn.empty();
        _this.gotTurn(entity);
      }
    };
    tick();
  },

  /**
   * Increases the entities&#x27; turn stat by 1 and returns an entity if it has reached its max turn stat value
   *
   * @method _getEntityTurn
   * @private
   * @returns Hiraya.EntityTurnBased
   */
  _getEntityTurn: function() {
    var total = this.entities.length;
    var entity;
    var result;
    for(var i=0; i&lt;total; i++) {
      entity = this.entities.at(i);
      entity.stats.turn.add(entity.stats.turnspeed.value);
      if (entity.stats.turn.isMax()) {
        result = entity;
        break;
      }
    }
    return result;
  },

  /**
   * Checks to see if there is already a winning entity in the game.
   *
   * @method evaluateEntities
   * @returns null
   */
  evaluateEntities: function() {
    var enabled = [];
    var disabled = [];
    this.entities.each(function(entity) {
      if (entity.stats.health.isEmpty()) {
        disabled.push(entity);
      } else {
        enabled.push(entity);
      }
    });
    if (enabled.length &lt;= 1) {
      this.hasWinner(enabled[0]);
    } else {
      this.hasNoWinnerYet();
    }
  },

  /**
   * Finds the nearest entities based on closed proximity.
   *
   * @method promixity
   * @param {Hiraya.EntityTurnBased} entity
   * @param {String} [by=null]
   * @returns {Array}
   */
  proximity: function(entity, by) {
    var distances = [],
      entities = [],
      tiles,
      radius = Math.floor(this.tiles.columns * 0.5)
    ;
    if (by === &#x27;range&#x27;) {
      radius = entity.stats.range.value;
    }
    tiles = this.tiles.range(entity.tile, radius, true);
    for(var i=0,len=tiles.length; i&lt;len; i++) {
      var tile = tiles[i];
      var occupant = tile.entities[0];
      if (occupant &amp;&amp; occupant !== entity) {
        if (occupant.stats.health.isEmpty()) {
          continue;
        }
        var distance = Math.abs(occupant.tile.x - entity.tile.x + occupant.tile.y - entity.tile.y);
        var index = 0;
        for(var ii=0, llen=distances.length; ii&lt;llen; ii++) {
          if (distance &lt; distances[ii]) {
            index = ii;
            break;
          }
        }
        distances.splice(index, 0, distance);
        entities.splice(index, 0, occupant);
      }
    }
    return entities;
  },

  /**
   * Gets the nearest tile of an entity from a tile. Basic path finding helper in finding
   *
   * @method nearestEntityTileFrom
   * @param {Hiraya.Entity} entity
   * @returns {Hiraya.Tile}
   */
  nearestEntityTileFrom: function(entity, tile) {
    var proximity = this.proximity(entity);
    var target = proximity[0];
    var nearest;
    if (target) {
      nearest = entity.tile.nearest(this.tiles.adjacent(target.tile));
    }
    return nearest;
  },

  /**
   * Fired when an entity reaches its max &#x60;.stats.turnspeed&#x60; value.
   *
   * @event gotTurn
   * @param {Hiraya.EntityTurnBased} entity
   */
  gotTurn: function(entity) {
  },

  /**
   * Fired when a winner has been announced after performing a &#x60;.evaluateEntities()&#x60; function.
   *
   * @event hasWinner
   * @param {Hiraya.EntityTurnBased} entity
   */
  hasWinner: function(entity) {
  },

  /**
   * Fired when there is no winner yet after performing a &#x60;.evaluateEntities()&#x60; function.
   *
   * @event hasNoWinnerYet
   */
  hasNoWinnerYet: function() {
  },

  /**
   * Fired when attempts in finding an entity to take its turn has reached its maximum number of tries.
   *
   * @event getTurnTimedOut
   */
  getTurnTimedOut: function() {
  }
});


module.exports = LevelTurnBased;

    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/jquery/jquery-1.8.2.min.js"></script>
<script src="../assets/vendor/bootstrap/js/bootstrap.js"></script>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script src="../assets/js/yuidoc-bootstrap.js"></script>
<script>prettyPrint();</script>
</body>
</html>
